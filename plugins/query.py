import random
import requests
import logging
import asyncio
import aiohttp 
from bot import Bot
from pyrogram import __version__
from plugins.FORMATS import *
from config import *
from pyrogram.enums import ParseMode, ChatAction
from plugins.autoDelete import convert_time
from database.database import db
from datetime import timedelta
from pyrogram.types import Message, InlineKeyboardMarkup, InlineKeyboardButton, CallbackQuery, InputMediaPhoto, ReplyKeyboardMarkup, ReplyKeyboardRemove



logging.basicConfig(
    level=logging.INFO,  # Set the logging level (e.g., DEBUG, INFO, WARNING, ERROR, CRITICAL)
    format='%(asctime)s - %(levelname)s - %(message)s',
    datefmt='%Y-%m-%d %H:%M:%S'
)

async def fileSettings(getfunc, setfunc=None, delfunc=False):
    btn_mode, txt_mode, pic_mode = '‚ùå', off_txt, off_pic
    del_btn_mode = '·¥á…¥·¥Ä ô ü·¥á ‚úÖ'
    try:
        if not setfunc:
            if await getfunc():
                txt_mode = on_txt
                btn_mode = '‚úÖ'
                del_btn_mode = '·¥Ö…™s·¥Ä ô ü·¥á ‚ùå'

            return txt_mode, (del_btn_mode if delfunc else btn_mode)

        else:
            if await getfunc():
                await setfunc(False)
            else:
                await setfunc(True)
                pic_mode, txt_mode = on_pic, on_txt
                btn_mode = '‚úÖ'
                del_btn_mode = '·¥Ö…™s·¥Ä ô ü·¥á ‚ùå'

            return pic_mode, txt_mode, (del_btn_mode if delfunc else btn_mode)

    except Exception as e:
        print(
            f"Error occured at [fileSettings(getfunc, setfunc=None, delfunc=False)] : {e}")


# Function to fetch anime data asynchronously
async def fetch_anime_data(api_url):
    async with aiohttp.ClientSession() as session:
        async with session.get(api_url) as response:
            response.raise_for_status()
            return await response.json()

# Function to get top anime asynchronously
async def get_top_anime():
    url = "https://api.jikan.moe/v4/top/anime"
    data = await fetch_anime_data(url)
    return data.get("data", [])

# Function to get weekly anime asynchronously
async def get_weekly_anime():
    url = "https://api.jikan.moe/v4/seasons/now"
    data = await fetch_anime_data(url)
    return data.get("data", [])

# Function to search for anime asynchronously
async def search_anime(query):
    url = f"https://api.jikan.moe/v4/anime?q={query}&page=1"
    data = await fetch_anime_data(url)
    return data.get("data", [])

# Cool font style for the anime title
def style_anime_title(title):
    return f"{title}".replace("A", "·¥Ä").replace("B", " ô").replace("C", "·¥Ñ").replace("D", "·¥Ö").replace("E", "·¥á").replace("F", "“ì").replace("G", "…¢").replace("H", " ú").replace("I", "…™").replace("J", "·¥ä").replace("K", "·¥ã").replace("L", " ü").replace("M", "·¥ç").replace("N", "…¥").replace("O", "·¥è").replace("P", "·¥ò").replace("Q", "«´").replace("R", " Ä").replace("S", "s").replace("T", "·¥õ").replace("U", "·¥ú").replace("V", "·¥†").replace("W", "·¥°").replace("X", "x").replace("Y", " è").replace("Z", "·¥¢")

# Get an emoji based on the anime title
def get_anime_emoji(title):
    emojis = ["‚ú®", "üåü", "üí´", "üî•", "üí•", "üå∏", "üéâ", "üéá", "üéÜ", "‚ö°"]
    return emojis[hash(title) % len(emojis)]
# Provide or Make Button by takiing required modes and data

def buttonStatus(pc_data: str, hc_data: str, cb_data: str) -> list:
    button = [
        [
            InlineKeyboardButton(
                f'‚Ä¢ ·¥ò·¥Ñ: {pc_data}', callback_data='pc'),
            InlineKeyboardButton(
                f'‚Ä¢  ú·¥Ñ: {hc_data}', callback_data='hc')
        ],
        [
            InlineKeyboardButton(
                f'‚Ä¢ ·¥Ñ ô: {cb_data}', callback_data='cb'),
            InlineKeyboardButton(f's ô ‚Ä¢', callback_data='setcb')
        ],
        [
            InlineKeyboardButton('‚Ä¢  Ä·¥á“ì Ä·¥ás ú', callback_data='files_cmd'),
            InlineKeyboardButton('·¥Ñ ü·¥ès·¥á ‚Ä¢', callback_data='close')
        ],
    ]
    return button

# Verify user, if he/she is admin or owner before processing the query...


async def authoUser(query, id, owner_only=False):
    if not owner_only:
        if not any([id == OWNER_ID, await db.admin_exist(id)]):
            await query.answer("‚ùå  è·¥è·¥ú ·¥Ä Ä·¥á …¥·¥è·¥õ ·¥Ä…¥ ·¥Ä·¥Ö·¥ç…™…¥ …™…¥ ·¥õ ú…™s  ô·¥è·¥õ  ô·¥Ä ô·¥á è è è...!!!", show_alert=True)
            return False
        return True
    else:
        if id != OWNER_ID:
            await query.answer("‚ùå  è·¥è·¥ú ·¥Ä Ä·¥á …¥·¥è·¥õ ·¥õ ú·¥á ·¥è·¥°…¥·¥á Ä ·¥è“ì ·¥õ ú…™s  ô·¥è·¥õ  ô·¥Ä ô·¥á è è è...!!!", show_alert=True)
            return False
        return True


@Bot.on_callback_query()
async def cb_handler(client: Bot, query: CallbackQuery):
    data = query.data
    if data == "close":
        await query.message.delete()
        try:
            await query.message.reply_to_message.delete()
        except BaseException:
            pass

    elif data == "about":
        user = await client.get_users(OWNER_ID)
        user_link = f"https://t.me/{user.username}" if user.username else f"tg://openmessage?user_id={OWNER_ID}" 
        ownername = f"<a href={user_link}>{user.first_name}</a>" if user.first_name else f"<a href={user_link}>no name !</a>"
        await query.edit_message_media(
            InputMediaPhoto("https://envs.sh/H2r.jpg", 
                            ABOUT_TXT.format(
                                botname = client.name,
                                ownername = ownername, 
                            )
            ),
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton('‚Ä¢  ô·¥Ä·¥Ñ·¥ã', callback_data='start'), InlineKeyboardButton('s·¥õ·¥Ä·¥õs ‚Ä¢', callback_data='setting')]
            ]),
        )

    elif data == "setting":
        await query.edit_message_media(InputMediaPhoto(random.choice(PICS), "<b>¬ª ·¥ò ü·¥á·¥Äs·¥á w·¥Ä…™·¥õ ·¥Ä s·¥á·¥Ñ·¥è…¥·¥Ö  ô·¥Ä ô·¥á è è !!</b>"))
        try:
            total_fsub = len(await db.get_all_channels())
            total_admin = len(await db.get_all_admins())
            total_ban = len(await db.get_ban_users())
            autodel_mode = '·¥á…¥·¥Ä ô ü·¥á·¥Ö' if await db.get_auto_delete() else '·¥Ö…™s·¥Ä ô ü·¥á·¥Ö'
            protect_content = '·¥á…¥·¥Ä ô ü·¥á·¥Ö' if await db.get_protect_content() else '·¥Ö…™s·¥Ä ô ü·¥á·¥Ö'
            hide_caption = '·¥á…¥·¥Ä ô ü·¥á·¥Ö' if await db.get_hide_caption() else '·¥Ö…™s·¥Ä ô ü·¥á·¥Ö'
            chnl_butn = '·¥á…¥·¥Ä ô ü·¥á·¥Ö' if await db.get_channel_button() else '·¥Ö…™s·¥Ä ô ü·¥á·¥Ö'
            reqfsub = '·¥á…¥·¥Ä ô ü·¥á·¥Ö' if await db.get_request_forcesub() else '·¥Ö…™s·¥Ä ô ü·¥á·¥Ö'

            await query.edit_message_media(
                InputMediaPhoto(random.choice(PICS),
                                SETTING_TXT.format(
                                    total_fsub=total_fsub,
                                    total_admin=total_admin,
                                    total_ban=total_ban,
                                    autodel_mode=autodel_mode,
                                    protect_content=protect_content,
                                    hide_caption=hide_caption,
                                    chnl_butn=chnl_butn,
                                    reqfsub=reqfsub
                )
                ),
                reply_markup=InlineKeyboardMarkup([
                    [InlineKeyboardButton('‚Ä¢  ô·¥Ä·¥Ñ·¥ã', callback_data='start'), InlineKeyboardButton(
                        '·¥Ñ ü·¥ès·¥á ‚Ä¢', callback_data='close')]
                ]),
            )
        except Exception as e:
            print(f"! Error Occurred on callback data = 'setting' : {e}")

    elif data == "start":
        await query.edit_message_media(
            InputMediaPhoto(random.choice(PICS),
                            START_MSG.format(
                                first=query.from_user.first_name,
                                last=query.from_user.last_name,
                                username=None if not query.from_user.username else '@' + query.from_user.username,
                                mention=query.from_user.mention,
                                id=query.from_user.id
            )
            ),
            reply_markup=InlineKeyboardMarkup([
                    [InlineKeyboardButton("‚Ä¢ ·¥Ñ ü…™·¥Ñ·¥ã “ì·¥è Ä ·¥ç·¥è Ä·¥á ‚Ä¢", callback_data='about')],
                    [InlineKeyboardButton("‚Ä¢ s·¥á·¥õ·¥õ…™…¥…¢s", callback_data='setting'),
                     InlineKeyboardButton('·¥Ö·¥á·¥†·¥á ü·¥è·¥ò·¥á Ä ‚Ä¢', url='https://t.me/urr_sanjiii')],
                    [InlineKeyboardButton("‚Ä¢ ·¥è·¥ú Ä ·¥Ä…¥…™·¥ç·¥á ·¥Ñ·¥è·¥ç·¥ç·¥ú…¥…™·¥õ è ‚Ä¢", url='https://t.me/Battousi_Network')],
                ]),
        )

    elif data == "files_cmd":
        if await authoUser(query, query.from_user.id):
            await query.answer("‚ôªÔ∏è Q·¥ú·¥á Ä è P Ä·¥è·¥Ñ·¥áss…™…¥…¢....!!!")

            try:
                protect_content, pcd = await fileSettings(db.get_protect_content)
                hide_caption, hcd = await fileSettings(db.get_hide_caption)
                channel_button, cbd = await fileSettings(db.get_channel_button)
                name, link = await db.get_channel_button_link()

                await query.edit_message_media(
                    InputMediaPhoto(files_cmd_pic,
                                    FILES_CMD_TXT.format(
                                        protect_content=protect_content,
                                        hide_caption=hide_caption,
                                        channel_button=channel_button,
                                        name=name,
                                        link=link
                                    )
                                    ),
                    reply_markup=InlineKeyboardMarkup(
                        buttonStatus(pcd, hcd, cbd)),
                )
            except Exception as e:
                print(f"! Error Occurred on callback data = 'files_cmd' : {e}")

    elif data == "pc":
        if await authoUser(query, query.from_user.id):
            await query.answer("‚ôªÔ∏è Q·¥ú·¥á Ä è P Ä·¥è·¥Ñ·¥áss…™…¥…¢....!!!")

            try:
                pic, protect_content, pcd = await fileSettings(db.get_protect_content, db.set_protect_content)
                hide_caption, hcd = await fileSettings(db.get_hide_caption)
                channel_button, cbd = await fileSettings(db.get_channel_button)
                name, link = await db.get_channel_button_link()

                await query.edit_message_media(
                    InputMediaPhoto(pic,
                                    FILES_CMD_TXT.format(
                                        protect_content=protect_content,
                                        hide_caption=hide_caption,
                                        channel_button=channel_button,
                                        name=name,
                                        link=link
                                    )
                                    ),
                    reply_markup=InlineKeyboardMarkup(
                        buttonStatus(pcd, hcd, cbd))
                )
            except Exception as e:
                print(f"! Error Occurred on callback data = 'pc' : {e}")

    elif data == "hc":
        if await authoUser(query, query.from_user.id):
            await query.answer("‚ôªÔ∏è Q·¥ú·¥á Ä è P Ä·¥è·¥Ñ·¥áss…™…¥…¢....!!!")

            try:
                protect_content, pcd = await fileSettings(db.get_protect_content)
                pic, hide_caption, hcd = await fileSettings(db.get_hide_caption, db.set_hide_caption)
                channel_button, cbd = await fileSettings(db.get_channel_button)
                name, link = await db.get_channel_button_link()

                await query.edit_message_media(
                    InputMediaPhoto(pic,
                                    FILES_CMD_TXT.format(
                                        protect_content=protect_content,
                                        hide_caption=hide_caption,
                                        channel_button=channel_button,
                                        name=name,
                                        link=link
                                    )
                                    ),
                    reply_markup=InlineKeyboardMarkup(
                        buttonStatus(pcd, hcd, cbd))
                )
            except Exception as e:
                print(f"! Error Occurred on callback data = 'hc' : {e}")

    elif data == "cb":
        if await authoUser(query, query.from_user.id):
            await query.answer("‚ôªÔ∏è Q·¥ú·¥á Ä è P Ä·¥è·¥Ñ·¥áss…™…¥…¢....!!!")

            try:
                protect_content, pcd = await fileSettings(db.get_protect_content)
                hide_caption, hcd = await fileSettings(db.get_hide_caption)
                pic, channel_button, cbd = await fileSettings(db.get_channel_button, db.set_channel_button)
                name, link = await db.get_channel_button_link()

                await query.edit_message_media(
                    InputMediaPhoto(pic,
                                    FILES_CMD_TXT.format(
                                        protect_content=protect_content,
                                        hide_caption=hide_caption,
                                        channel_button=channel_button,
                                        name=name,
                                        link=link
                                    )
                                    ),
                    reply_markup=InlineKeyboardMarkup(
                        buttonStatus(pcd, hcd, cbd))
                )
            except Exception as e:
                print(f"! Error Occurred on callback data = 'cb' : {e}")

    elif data == "setcb":
        id = query.from_user.id
        if await authoUser(query, id):
            await query.answer("‚ôªÔ∏è Q·¥ú·¥á Ä è P Ä·¥è·¥Ñ·¥áss…™…¥…¢....!!!")

            try:
                button_name, button_link = await db.get_channel_button_link()

                button_preview = [[InlineKeyboardButton(
                    text=button_name, url=button_link)]]
                set_msg = await client.ask(chat_id=id, text=f'<b>·¥õ·¥è ·¥Ñ ú·¥Ä…¥…¢·¥á ·¥õ ú·¥á  ô·¥ú·¥õ·¥õ·¥è…¥, ·¥ò ü·¥á·¥Äs·¥á s·¥á…¥·¥Ö ·¥†·¥Ä ü…™·¥Ö ·¥Ä Ä…¢·¥ú·¥ç·¥á…¥·¥õs ·¥°…™·¥õ ú…™…¥ 1 ·¥ç…™…¥·¥ú·¥õ·¥á.\n“ì·¥è Ä ·¥áx·¥Ä·¥ç·¥ò ü·¥á:\n<blockquote><code>¬ª  ·¥ä·¥è…™…¥ ·¥Ñ ú·¥Ä…¥…¥·¥á ü  ¬´ - https://t.me/anime_raven</code></blockquote>\n\n<i>¬ª  ô·¥á ü·¥è·¥° …™s  ô·¥ú·¥õ·¥õ·¥è…¥ ·¥ò Ä·¥á·¥†…™·¥á·¥° ‚¨áÔ∏è</i></b>', timeout=60, reply_markup=InlineKeyboardMarkup(button_preview), disable_web_page_preview=True)
                button = set_msg.text.split(' - ')

                if len(button) != 2:
                    markup = [[InlineKeyboardButton(
                        f'¬ª s·¥á·¥õ ·¥Ñ ú·¥Ä…¥…¥·¥á ü  ô·¥ú·¥õ·¥õ·¥è…¥ ¬´', callback_data='setcb')]]
                    return await set_msg.reply("<b>·¥ò ü·¥á·¥Äs·¥á s·¥á…¥·¥Ö ·¥†·¥Ä ü…™·¥Ö ·¥Ä Ä…¢·¥ú·¥ç·¥á…¥·¥õs.\n\n“ì·¥è Ä ·¥áx·¥Ä·¥ç·¥ò ü·¥á:\n<blockquote><code>¬ª  ·¥ä·¥è…™…¥ ·¥Ñ ú·¥Ä…¥…¥·¥á ü  ¬´ - https://t.me/anime_raven</code></blockquote>\n\n·¥õ Ä è ·¥Ä…¢·¥Ä…™…¥  ô è ·¥Ñ ü…™·¥Ñ·¥ã…™…¥…¢  ô·¥á ü·¥è·¥°  ô·¥ú·¥õ·¥õ·¥è…¥..</b>", reply_markup=InlineKeyboardMarkup(markup), disable_web_page_preview=True)

                button_name = button[0].strip()
                button_link = button[1].strip()
                button_preview = [[InlineKeyboardButton(
                    text=button_name, url=button_link)]]

                await set_msg.reply("<b> ô·¥ú·¥õ·¥õ·¥è…¥ ·¥Ä·¥Ö·¥Ö·¥á·¥Ö s·¥ú·¥Ñc·¥áss“ì·¥ú ü ü è ‚úÖ\n\n<blockquote>¬ª s·¥á·¥á  ô·¥á ü·¥è·¥°  ô·¥ú·¥õ·¥õ·¥è…¥ ·¥Äs ·¥ò Ä·¥á·¥†…™·¥á·¥° ‚¨áÔ∏è</blockquote></b>", reply_markup=InlineKeyboardMarkup(button_preview))
                await db.set_channel_button_link(button_name, button_link)
                return
            except Exception as e:
                try:
                    await set_msg.reply(f"<b>! ·¥á Ä Ä·¥è Ä ·¥è·¥Ñ·¥Ñ·¥ú Ä·¥á·¥Ö..\n<blockquote> Ä·¥á·¥Äs·¥è…¥:</b> {e}</blockquote>")
                    print(f"! Error Occurred on callback data = 'setcb' : {e}")
                except BaseException:
                    await client.send_message(id, text=f"<b>! ·¥á Ä Ä·¥è Ä ·¥è·¥Ñ·¥Ñ·¥ú Ä·¥á·¥Ö..\n\n<blockquote> Ä·¥á·¥Äs·¥è…¥: 1 minute Time out ..</b></blockquote>", disable_notification=True)
                    print(
                        f"! Error Occurred on callback data = 'setcb' -> R·¥á·¥Äs·¥è…¥: 1 minute Time out ..")

    elif data == 'autodel_cmd':
        if await authoUser(query, query.from_user.id, owner_only=True):
            await query.answer("‚ôªÔ∏è Q·¥ú·¥á Ä è P Ä·¥è·¥Ñ·¥áss…™…¥…¢....!!!")

            try:
                timer = convert_time(await db.get_del_timer())
                autodel_mode, mode = await fileSettings(db.get_auto_delete, delfunc=True)

                await query.edit_message_media(
                    InputMediaPhoto(autodel_cmd_pic,
                                    AUTODEL_CMD_TXT.format(
                                        autodel_mode=autodel_mode,
                                        timer=timer
                                    )
                                    ),
                    reply_markup=InlineKeyboardMarkup([
                        [InlineKeyboardButton(mode, callback_data='chng_autodel'), InlineKeyboardButton(
                            's·¥á·¥õ ·¥õ…™·¥ç·¥á Ä', callback_data='set_timer')],
                        [InlineKeyboardButton(' Ä·¥á“ì Ä·¥ás ú', callback_data='autodel_cmd'), InlineKeyboardButton(
                            '·¥Ñ ü·¥ès·¥á', callback_data='close')]
                    ])
                )
            except Exception as e:
                print(
                    f"! Error Occurred on callback data = 'autodel_cmd' : {e}")

    elif data == 'chng_autodel':
        if await authoUser(query, query.from_user.id, owner_only=True):
            await query.answer("‚ôªÔ∏è Q·¥ú·¥á Ä è P Ä·¥è·¥Ñ·¥áss…™…¥…¢....!!!")

            try:
                timer = convert_time(await db.get_del_timer())
                pic, autodel_mode, mode = await fileSettings(db.get_auto_delete, db.set_auto_delete, delfunc=True)

                await query.edit_message_media(
                    InputMediaPhoto(pic,
                                    AUTODEL_CMD_TXT.format(
                                        autodel_mode=autodel_mode,
                                        timer=timer
                                    )
                                    ),
                    reply_markup=InlineKeyboardMarkup([
                        [InlineKeyboardButton(mode, callback_data='chng_autodel'), InlineKeyboardButton(
                            's·¥á·¥õ ·¥õ…™·¥ç·¥á Ä', callback_data='set_timer')],
                        [InlineKeyboardButton(' Ä·¥á“ì Ä·¥ás ú', callback_data='autodel_cmd'), InlineKeyboardButton(
                            '·¥Ñ ü·¥ès·¥á', callback_data='close')]
                    ])
                )
            except Exception as e:
                print(
                    f"! Error Occurred on callback data = 'chng_autodel' : {e}")

    elif data == 'set_timer':
        id = query.from_user.id
        if await authoUser(query, id, owner_only=True):
            try:

                timer = convert_time(await db.get_del_timer())
                set_msg = await client.ask(chat_id=id, text=f'<b><blockquote>¬ª ·¥Ñ·¥ú Ä Ä·¥á…¥·¥õ ·¥õ…™·¥ç·¥á Ä: {timer}</blockquote>\n\n¬ª ·¥õ·¥è ·¥Ñ ú·¥Ä…¥…¢·¥á ·¥õ…™·¥ç·¥á Ä, ·¥ò ü·¥á·¥Äs·¥á s·¥á…¥·¥Ö ·¥†·¥Ä ü…™·¥Ö …¥·¥ú·¥ç ô·¥á Ä …™…¥ s·¥á·¥Ñ·¥è…¥·¥Ös ·¥°…™·¥õ ú…™…¥ 1 ·¥ç…™…¥·¥ú·¥õ·¥á.\n\n<blockquote>“ì·¥è Ä ·¥áx·¥Ä·¥ç·¥ò ü·¥á: <code>300</code>, <code>600</code>, <code>900</code></b></blockquote>', timeout=60)
                del_timer = set_msg.text.split()

                if len(del_timer) == 1 and del_timer[0].isdigit():
                    DEL_TIMER = int(del_timer[0])
                    await db.set_del_timer(DEL_TIMER)
                    timer = convert_time(DEL_TIMER)
                    await set_msg.reply(f"<b>·¥õ…™·¥ç·¥á Ä ·¥Ä·¥Ö·¥Ö·¥á·¥Ö s·¥ú·¥Ñc·¥áss“ì·¥ú ü ü è ‚úÖ\n\n<blockquote>¬ª ·¥Ñ·¥ú Ä Ä·¥á…¥·¥õ ·¥õ…™·¥ç·¥á Ä: {timer}</blockquote></b>")
                else:
                    markup = [[InlineKeyboardButton(
                        '¬ª s·¥á·¥õ ·¥Ö·¥á ü·¥á·¥õ·¥á ·¥õ…™·¥ç·¥á Ä ¬´', callback_data='set_timer')]]
                    return await set_msg.reply("<b>·¥ò ü·¥á·¥Äs·¥á s·¥á…¥·¥Ö ·¥†·¥Ä ü…™·¥Ö …¥·¥ú·¥ç ô·¥á Ä …™…¥ s·¥á·¥Ñ·¥è…¥·¥Ös.\n\n<blockquote>“ì·¥è Ä ·¥áx·¥Ä·¥ç·¥ò ü·¥á: <code>300</code>, <code>600</code>, <code>900</code></blockquote>\n\n¬ª ·¥õ Ä è ·¥Ä…¢·¥Ä…™…¥  ô è ·¥Ñ ü…™·¥Ñ·¥ã…™…¥…¢  ô·¥á ü·¥è·¥°  ô·¥ú·¥õ·¥õ·¥è…¥.</b>", reply_markup=InlineKeyboardMarkup(markup))

            except Exception as e:
                try:
                    await set_msg.reply(f"<b>! ·¥á Ä Ä·¥è Ä ·¥è·¥Ñ·¥Ñ·¥ú Ä·¥á·¥Ö..\n\n<blockquote> Ä·¥á·¥Äs·¥è…¥:</b> {e}</blockquote>")
                    print(
                        f"! Error Occurred on callback data = 'set_timer' : {e}")
                except BaseException:
                    await client.send_message(id, text=f"<b>! ·¥á Ä Ä·¥è Ä ·¥è·¥Ñ·¥Ñ·¥ú Ä·¥á·¥Ö..\n\n<blockquote>¬ª  Ä·¥á·¥Äs·¥è…¥: 1 ·¥ç…™…¥·¥ú·¥õ·¥á ·¥õ…™·¥ç·¥á ·¥è·¥ú·¥õ...!!!</b></blockquote>", disable_notification=True)
                    print(
                        f"! Error Occurred on callback data = 'set_timer' -> R·¥á·¥Äs·¥è…¥: 1 minute Time out ..")

    elif data == 'chng_req':
        if await authoUser(query, query.from_user.id, owner_only=True):
            await query.answer("‚ôªÔ∏è Q·¥ú·¥á Ä è P Ä·¥è·¥Ñ·¥áss…™…¥…¢....!!!")

            try:
                on = off = ""
                if await db.get_request_forcesub():
                    await db.set_request_forcesub(False)
                    off = "üî¥"
                    texting = off_txt
                else:
                    await db.set_request_forcesub(True)
                    on = "üü¢"
                    texting = on_txt

                button = [
                    [InlineKeyboardButton(f"{on} ·¥è…¥", "chng_req"), InlineKeyboardButton(
                        f"{off} ·¥è“ì“ì", "chng_req")],
                    [InlineKeyboardButton(
                        "‚Ä¢  ·¥ç·¥è Ä·¥á s·¥á·¥õ·¥õ…™…¥…¢s  ‚Ä¢", "more_settings")]
                ]
                # üéâ)
                await query.message.edit_text(text=RFSUB_CMD_TXT.format(req_mode=texting), reply_markup=InlineKeyboardMarkup(button))

            except Exception as e:
                print(f"! Error Occurred on callback data = 'chng_req' : {e}")

    elif data == 'more_settings':
        if await authoUser(query, query.from_user.id, owner_only=True):
            # await query.answer("‚ôªÔ∏è Q·¥ú·¥á Ä è P Ä·¥è·¥Ñ·¥áss…™…¥…¢....")
            try:
                await query.message.edit_text("<b>¬ª ·¥ò ü·¥á·¥Äs·¥á w·¥Ä…™·¥õ ·¥Ä s·¥á·¥Ñ·¥è…¥·¥Ö  ô·¥Ä ô·¥á è è !!</b>")
                LISTS = "·¥á·¥ç·¥ò·¥õ è  Ä·¥á«´·¥ú·¥ás·¥õ “ì·¥è Ä·¥Ñ·¥á-s·¥ú ô ·¥Ñ ú·¥Ä…¥…¥·¥á ü  ü…™s·¥õ !?"

                REQFSUB_CHNLS = await db.get_reqChannel()
                if REQFSUB_CHNLS:
                    LISTS = ""
                    channel_name = "·¥ú…¥·¥Ä ô ü·¥á  ü·¥è·¥Ä·¥Ö …¥·¥Ä·¥ç·¥ás..."
                    for CHNL in REQFSUB_CHNLS:
                        await query.message.reply_chat_action(ChatAction.TYPING)
                        try:
                            name = (await client.get_chat(CHNL)).title
                        except BaseException:
                            name = None
                        channel_name = name if name else channel_name

                        user = await db.get_reqSent_user(CHNL)
                        channel_users = len(user) if user else 0

                        link = await db.get_stored_reqLink(CHNL)
                        if link:
                            channel_name = f"<a href={link}>{channel_name}</a>"

                        LISTS += f"NAME: {channel_name}\n(ID: <code>{CHNL}</code>)\nUSERS: {channel_users}\n\n"

                buttons = [
                    [InlineKeyboardButton("‚Ä¢ ·¥Ñ ü·¥á·¥Ä Ä ·¥ús·¥á Äs", "clear_users"), InlineKeyboardButton(
                        "c ü·¥á·¥Ä Ä c ú·¥Ä…¥…¥·¥á üs ‚Ä¢", "clear_chnls")],
                    [InlineKeyboardButton(
                        "‚Ä¢   Ä·¥á“ì Ä·¥ás ú s·¥õ·¥Ä·¥õ·¥ús  ‚Ä¢", "more_settings")],
                    [InlineKeyboardButton("‚Ä¢  ô·¥Ä·¥Ñ·¥ã", "req_fsub"), InlineKeyboardButton(
                        "·¥Ñ ü·¥ès·¥á ‚Ä¢", "close")]
                ]
                await query.message.reply_chat_action(ChatAction.CANCEL)
                await query.message.edit_text(text=RFSUB_MS_TXT.format(reqfsub_list=LISTS.strip()), reply_markup=InlineKeyboardMarkup(buttons))

            except Exception as e:
                print(
                    f"! Error Occurred on callback data = 'more_settings' : {e}")

    elif data == 'clear_users':
        # if await authoUser(query, query.from_user.id, owner_only=True) :
        # await query.answer("‚ôªÔ∏è Q·¥ú·¥á Ä è P Ä·¥è·¥Ñ·¥áss…™…¥…¢....")
        try:
            REQFSUB_CHNLS = await db.get_reqChannel()
            if not REQFSUB_CHNLS:
                return await query.answer("·¥á·¥ç·¥ò·¥õ è  Ä·¥á«´·¥ú·¥ás·¥õ “ì·¥è Ä·¥Ñ·¥á-s·¥ú ô ·¥Ñ ú·¥Ä…¥…¥·¥á ü !?", show_alert=True)

            await query.answer("‚ôªÔ∏è Q·¥ú·¥á Ä è P Ä·¥è·¥Ñ·¥áss…™…¥…¢...!!!")

            REQFSUB_CHNLS = list(map(str, REQFSUB_CHNLS))
            buttons = [REQFSUB_CHNLS[i:i + 2]
                       for i in range(0, len(REQFSUB_CHNLS), 2)]
            buttons.insert(0, ['CANCEL'])
            buttons.append(['DELETE ALL CHANNELS USER'])

            user_reply = await client.ask(query.from_user.id, text=CLEAR_USERS_TXT, reply_markup=ReplyKeyboardMarkup(buttons, one_time_keyboard=True, resize_keyboard=True))

            if user_reply.text == 'CANCEL':
                return await user_reply.reply("<b>üÜë ·¥Ñ·¥Ä…¥·¥Ñ·¥á ü ü·¥á·¥Ö...!!!</b>", reply_markup=ReplyKeyboardRemove())

            elif user_reply.text in REQFSUB_CHNLS:
                try:
                    await db.clear_reqSent_user(int(user_reply.text))
                    return await user_reply.reply(f"<b><blockquote>‚úÖ ·¥ús·¥á Ä ·¥Ö·¥Ä·¥õ·¥Ä s·¥ú·¥Ñ·¥Ñ·¥áss“ì·¥ú ü ü è ·¥Ñ ü·¥á·¥Ä Ä·¥á·¥Ö “ì Ä·¥è·¥ç ·¥Ñ ú·¥Ä…¥…¥·¥á ü …™·¥Ö: <code>{user_reply.text}</code></blockquote></b>", reply_markup=ReplyKeyboardRemove())
                except Exception as e:
                    return await user_reply.reply(f"<b>! ·¥á Ä Ä·¥è Ä ·¥è·¥Ñ·¥Ñ·¥ú Ä·¥á·¥Ö...\n\n<blockquote> Ä·¥á·¥Äs·¥è…¥:</b> {e}</blockquote>", reply_markup=ReplyKeyboardRemove())

            elif user_reply.text == 'DELETE ALL CHANNELS USER':
                try:
                    for CHNL in REQFSUB_CHNLS:
                        await db.clear_reqSent_user(int(CHNL))
                    return await user_reply.reply(f"<b><blockquote>‚úÖ ·¥ús·¥á Ä ·¥Ö·¥Ä·¥õ·¥Ä s·¥ú·¥Ñ·¥Ñ·¥áss“ì·¥ú ü ü è ·¥Ñ ü·¥á·¥Ä Ä·¥á·¥Ö “ì Ä·¥è·¥ç ·¥Ä ü ü ·¥Ñ ú·¥Ä…¥…¥·¥á ü …™·¥Ös</blockquote></b>", reply_markup=ReplyKeyboardRemove())
                except Exception as e:
                    return await user_reply.reply(f"<b>! ·¥á Ä Ä·¥è Ä ·¥è·¥Ñ·¥Ñ·¥ú Ä·¥á·¥Ö...\n<blockquote> Ä·¥á·¥Äs·¥è…¥:</b> {e}</blockquote>", reply_markup=ReplyKeyboardRemove())

            else:
                return await user_reply.reply(f"<b><blockquote>INVALID SELECTIONS</blockquote></b>", reply_markup=ReplyKeyboardRemove())

        except Exception as e:
            print(f"! Error Occurred on callback data = 'clear_users' : {e}")

    elif data == 'clear_chnls':
        # if await authoUser(query, query.from_user.id, owner_only=True)

        try:
            REQFSUB_CHNLS = await db.get_reqChannel()
            if not REQFSUB_CHNLS:
                return await query.answer("·¥á·¥ç·¥ò·¥õ è  Ä·¥á«´·¥ú·¥ás·¥õ “ì·¥è Ä·¥Ñ·¥á-s·¥ú ô ·¥Ñ ú·¥Ä…¥…¥·¥á ü !?", show_alert=True)

            await query.answer("‚ôªÔ∏è Q·¥ú·¥á Ä è P Ä·¥è·¥Ñ·¥áss…™…¥…¢....!!!")

            REQFSUB_CHNLS = list(map(str, REQFSUB_CHNLS))
            buttons = [REQFSUB_CHNLS[i:i + 2]
                       for i in range(0, len(REQFSUB_CHNLS), 2)]
            buttons.insert(0, ['CANCEL'])
            buttons.append(['DELETE ALL CHANNEL IDS'])

            user_reply = await client.ask(query.from_user.id, text=CLEAR_CHNLS_TXT, reply_markup=ReplyKeyboardMarkup(buttons, one_time_keyboard=True, resize_keyboard=True))

            if user_reply.text == 'CANCEL':
                return await user_reply.reply("<b>üÜë ·¥Ñ·¥Ä…¥·¥Ñ·¥á ü ü·¥á·¥Ö...!!!</b>", reply_markup=ReplyKeyboardRemove())

            elif user_reply.text in REQFSUB_CHNLS:
                try:
                    chnl_id = int(user_reply.text)

                    await db.del_reqChannel(chnl_id)

                    try:
                        await client.revoke_chat_invite_link(chnl_id, await db.get_stored_reqLink(chnl_id))
                    except BaseException:
                        pass

                    await db.del_stored_reqLink(chnl_id)

                    return await user_reply.reply(f"<b><blockquote><code>{user_reply.text}</code> ·¥Ñ ú·¥Ä…¥…¥·¥á ü …™·¥Ö ·¥Ä ü·¥è…¥…¢ ·¥°…™·¥õ ú …™·¥õs ·¥Ö·¥Ä·¥õ·¥Ä s·¥ú·¥Ñ·¥Ñ·¥áss“ì·¥ú ü ü è ·¥Ö·¥á ü·¥á·¥õ·¥á·¥Ö ‚úÖ</blockquote></b>", reply_markup=ReplyKeyboardRemove())
                except Exception as e:
                    return await user_reply.reply(f"<b>! ·¥á Ä Ä·¥è Ä ·¥è·¥Ñ·¥Ñ·¥ú Ä·¥á·¥Ö...\n\n<blockquote> Ä·¥á·¥Äs·¥è…¥:</b> {e}</blockquote>", reply_markup=ReplyKeyboardRemove())

            elif user_reply.text == 'DELETE ALL CHANNEL IDS':
                try:
                    for CHNL in REQFSUB_CHNLS:
                        chnl = int(CHNL)

                        await db.del_reqChannel(chnl)

                        try:
                            await client.revoke_chat_invite_link(chnl, await db.get_stored_reqLink(chnl))
                        except BaseException:
                            pass

                        await db.del_stored_reqLink(chnl)

                    return await user_reply.reply(f"<b><blockquote>·¥Ä ü ü ·¥Ñ ú·¥Ä…¥…¥·¥á ü …™·¥Ös ·¥Ä ü·¥è…¥…¢ ·¥°…™·¥õ ú …™·¥õs ·¥Ö·¥Ä·¥õ·¥Ä s·¥ú·¥Ñ·¥Ñ·¥áss“ì·¥ú ü ü è ·¥Ö·¥á ü·¥á·¥õ·¥á·¥Ö ‚úÖ</blockquote></b>", reply_markup=ReplyKeyboardRemove())

                except Exception as e:
                    return await user_reply.reply(f"<b>! ·¥á Ä Ä·¥è Ä ·¥è·¥Ñ·¥Ñ·¥ú Ä·¥á·¥Ö...\n\n<blockquote> Ä·¥á·¥Äs·¥è…¥:</b> {e}</blockquote>", reply_markup=ReplyKeyboardRemove())

            else:
                return await user_reply.reply(f"<b><blockquote>INVALID SELECTIONS</blockquote></b>", reply_markup=ReplyKeyboardRemove())

        except Exception as e:
            print(f"! Error Occurred on callback data = 'more_settings' : {e}")

    elif data == 'clear_links':
        # if await authoUser(query, query.from_user.id, owner_only=True) :
        # await query.answer("‚ôªÔ∏è Q·¥ú·¥á Ä è P Ä·¥è·¥Ñ·¥áss…™…¥…¢....")

        try:
            REQFSUB_CHNLS = await db.get_reqLink_channels()
            if not REQFSUB_CHNLS:
                return await query.answer("…¥·¥è s·¥õ·¥è Ä·¥á·¥Ö  Ä·¥á«´·¥ú·¥ás·¥õ  ü…™…¥·¥ã ·¥Ä·¥†·¥Ä…™ ü·¥Ä ô ü·¥á !?", show_alert=True)

            await query.answer("‚ôªÔ∏è Q·¥ú·¥á Ä è P Ä·¥è·¥Ñ·¥áss…™…¥…¢....!!!")

            REQFSUB_CHNLS = list(map(str, REQFSUB_CHNLS))
            buttons = [REQFSUB_CHNLS[i:i + 2]
                       for i in range(0, len(REQFSUB_CHNLS), 2)]
            buttons.insert(0, ['CANCEL'])
            buttons.append(['DELETE ALL REQUEST LINKS'])

            user_reply = await client.ask(query.from_user.id, text=CLEAR_LINKS_TXT, reply_markup=ReplyKeyboardMarkup(buttons, one_time_keyboard=True, resize_keyboard=True))

            if user_reply.text == 'CANCEL':
                return await user_reply.reply("<b>üÜë ·¥Ñ·¥Ä…¥·¥Ñ·¥á ü ü·¥á·¥Ö...</b>", reply_markup=ReplyKeyboardRemove())

            elif user_reply.text in REQFSUB_CHNLS:
                channel_id = int(user_reply.text)
                try:
                    try:
                        await client.revoke_chat_invite_link(channel_id, await db.get_stored_reqLink(channel_id))
                    except BaseException:
                        text = """<b>‚ùå ·¥ú…¥·¥Ä ô ü·¥á ·¥õ·¥è  Ä·¥á·¥†·¥è·¥ã·¥á  ü…™…¥·¥ã !
<blockquote expandable>…™·¥Ö: <code>{}</code></b>

¬ª ·¥á…™·¥õ ú·¥á Ä ·¥õ ú·¥á  ô·¥è·¥õ …™s …¥·¥è·¥õ …™…¥ ·¥Ä ô·¥è·¥†·¥á ·¥Ñ ú·¥Ä…¥…¥·¥á ü ·¥è Ä ·¥Ö·¥è…¥'·¥õ  ú·¥Ä·¥†·¥á ·¥ò Ä·¥è·¥ò·¥á Ä ·¥Ä·¥Ö·¥ç…™…¥ ·¥ò·¥á Ä·¥ç…™ss…™·¥è…¥s</blockquote>"""
                        return await user_reply.reply(text=text.format(channel_id), reply_markup=ReplyKeyboardRemove())

                    await db.del_stored_reqLink(channel_id)
                    return await user_reply.reply(f"<b><blockquote><code>{channel_id}</code> ·¥Ñ ú·¥Ä…¥…¥·¥á üs  ü…™…¥·¥ã s·¥ú·¥Ñ·¥Ñ·¥áss“ì·¥ú ü ü è ·¥Ö·¥á ü·¥á·¥õ·¥á·¥Ö ‚úÖ</blockquote></b>", reply_markup=ReplyKeyboardRemove())

                except Exception as e:
                    return await user_reply.reply(f"<b>! ·¥á Ä Ä·¥è Ä ·¥è·¥Ñ·¥Ñ·¥ú Ä·¥á·¥Ö...\n\n<blockquote> Ä·¥á·¥Äs·¥è…¥:</b> {e}</blockquote>", reply_markup=ReplyKeyboardRemove())

            elif user_reply.text == 'DELETE ALL REQUEST LINKS':
                try:
                    result = ""
                    for CHNL in REQFSUB_CHNLS:
                        channel_id = int(CHNL)
                        try:
                            await client.revoke_chat_invite_link(channel_id, await db.get_stored_reqLink(channel_id))
                        except BaseException:
                            result += f"<blockquote expandable><b><code>{channel_id}</code> ·¥ú…¥·¥Ä ô ü·¥á ·¥õ·¥è  Ä·¥á·¥†·¥è·¥ã·¥á ‚ùå</b>\n\n¬ª ·¥á…™·¥õ ú·¥á Ä ·¥õ ú·¥á  ô·¥è·¥õ …™s …¥·¥è·¥õ …™…¥ ·¥Ä ô·¥è·¥†·¥á ·¥Ñ ú·¥Ä…¥…¥·¥á ü ·¥è Ä ·¥Ö·¥è…¥'·¥õ  ú·¥Ä·¥†·¥á ·¥ò Ä·¥è·¥ò·¥á Ä ·¥Ä·¥Ö·¥ç…™…¥ ·¥ò·¥á Ä·¥ç…™ss…™·¥è…¥s.</blockquote>\n"
                            continue
                        await db.del_stored_reqLink(channel_id)
                        result += f"<blockquote><b><code>{channel_id}</code> IDs  ü…™…¥·¥ã ·¥Ö·¥á ü·¥á·¥õ·¥á·¥Ö ‚úÖ</b></blockquote>\n"

                    return await user_reply.reply(f"<b>‚ÅâÔ∏è ·¥è·¥ò·¥á Ä·¥Ä·¥õ…™·¥è…¥  Ä·¥ás·¥ú ü·¥õ:</b>\n{result.strip()}", reply_markup=ReplyKeyboardRemove())

                except Exception as e:
                    return await user_reply.reply(f"<b>! ·¥á Ä Ä·¥è Ä ·¥è·¥Ñ·¥Ñ·¥ú Ä·¥á·¥Ö...\n\n<blockquote> Ä·¥á·¥Äs·¥è…¥:</b> {e}</blockquote>", reply_markup=ReplyKeyboardRemove())

            else:
                return await user_reply.reply(f"<b><blockquote>INVALID SELECTIONS</blockquote></b>", reply_markup=ReplyKeyboardRemove())

        except Exception as e:
            print(f"! Error Occurred on callback data = 'more_settings' : {e}")

    elif data == 'req_fsub':
        # if await authoUser(query, query.from_user.id, owner_only=True) :
        await query.answer("Q·¥ú·¥á Ä è P Ä·¥è·¥Ñ·¥áss…™…¥…¢...!!!")

        try:
            on = off = ""
            if await db.get_request_forcesub():
                on = "üü¢"
                texting = on_txt
            else:
                off = "üî¥"
                texting = off_txt

            button = [
                [InlineKeyboardButton(f"{on} ·¥è…¥", "chng_req"), InlineKeyboardButton(
                    f"{off} ·¥è“ì“ì", "chng_req")],
                [InlineKeyboardButton("‚Ä¢ ·¥ç·¥è Ä·¥á s·¥á·¥õ·¥õ…™…¥…¢s ‚Ä¢", "more_settings")]
            ]
            # üéâ)
            await query.message.edit_text(text=RFSUB_CMD_TXT.format(req_mode=texting), reply_markup=InlineKeyboardMarkup(button))

        except Exception as e:
            print(f"! Error Occurred on callback data = 'chng_req' : {e}")
    

    # Handle shortener settings
    elif data == "shortener_settings":
        if await authoUser(query, query.from_user.id, owner_only=True):
            try:
                await query.answer("¬ª “ì·¥á·¥õ·¥Ñ ú…™…¥…¢ s ú·¥è Ä·¥õ…¥·¥á Ä ·¥Ö·¥á·¥õ·¥Ä…™ üs...!!!")

            # Fetch shortener details
                shortener_url = await db.get_shortener_url()
                shortener_api = await db.get_shortener_api()
                verified_time = await db.get_verified_time()
                tut_video = await db.get_tut_video()

            # Prepare the details for display
                shortener_url_display = shortener_url or "Not set"
                shortener_api_display = shortener_api or "Not set"
                status = "Active" if shortener_url and shortener_api else "Inactive"
                verified_time_display = (
                    f"{verified_time} seconds" if verified_time else "Not set"
                )
                tut_video_display = (
                    f"[Tutorial Video]({tut_video})" if tut_video else "Not set"
                )

            # Response message
                response_text = (
                    f"<b>ùêíùêáùêéùêëùêìùêçùêÑùêë ùêÉùêÑùêìùêÄùêàùêãùêí</b>\n\n"
                    f"¬ª s ú·¥è Ä·¥õ…¥·¥á Ä s…™·¥õ·¥á: {shortener_url_display}\n"
                    f"¬ª s ú·¥è Ä·¥õ…¥·¥á Ä ·¥Ä·¥ò…™ ·¥õ·¥è·¥ã·¥á…¥: {shortener_api_display}\n\n"
                    f"¬ª s ú·¥è Ä·¥õ…¥·¥á Ä s·¥õ·¥Ä·¥õ·¥ús: {status}\n\n"
                    f"¬ª s ú·¥è Ä·¥õ…¥·¥á Ä ·¥†·¥á Ä…™“ì…™·¥á·¥Ö ·¥õ…™·¥ç·¥á: {verified_time_display}\n"
                    f"¬ª s ú·¥è Ä·¥õ…¥·¥á Ä ·¥õ·¥ú·¥õ·¥è Ä…™·¥Ä ü ·¥†…™·¥Ö·¥á·¥è: {tut_video_display}"
                )

            # Update the message with the fetched details
                await query.message.edit_text(
                    text=response_text,
                    reply_markup=InlineKeyboardMarkup([
                        [InlineKeyboardButton('‚Ä¢   ô·¥Ä·¥Ñ·¥ã  ‚Ä¢', callback_data='set_shortener')]
                    ]),
                    disable_web_page_preview=True  # Disable preview for tutorial video link
                )

            except Exception as e:
                logging.error(f"Error fetching shortener settings: {e}")
                await query.message.reply(
                    "ü§ß An error occurred while fetching shortener settings. Please try again later.",
                    reply_markup=InlineKeyboardMarkup([
                        [InlineKeyboardButton('‚Ä¢   ô·¥Ä·¥Ñ·¥ã  ‚Ä¢', callback_data='set_shortener')]
                    ])
                )


    elif data == "chng_shortener":  # Toggle shortener status
        user_id = query.from_user.id
        shortener_details = await db.get_shortener()

    # Toggle the shortener status in the database
        if shortener_details:
        # Disable shortener
            await db.set_shortener("", "")
            await query.answer("s ú·¥è Ä·¥õ…¥·¥á Ä ·¥Ö…™s·¥Ä ô ü·¥á·¥Ö ‚ùå", show_alert=True)
        else:
        # Enable shortener, prompt for URL and API Key
            await query.answer("¬ª s ú·¥è Ä·¥õ…¥·¥á Ä ·¥á…¥·¥Ä ô ü·¥á·¥Ö ‚úÖ. ·¥ò ü·¥á·¥Äs·¥á ·¥ò Ä·¥è·¥†…™·¥Ö·¥á ·¥õ ú·¥á s ú·¥è Ä·¥õ…¥·¥á Ä ·¥ú Ä ü ·¥Ä…¥·¥Ö ·¥Ä·¥ò…™ ·¥ã·¥á è.", show_alert=True)
            await query.message.reply("¬ª s·¥á…¥·¥Ö ·¥õ ú·¥á ùêíùêáùêéùêëùêìùêçùêÑùêë ùêîùêëùêã ·¥Ä…¥·¥Ö ùêÄùêèùêà ùêäùêÑùêò …™…¥ ·¥õ ú·¥á “ì·¥è Ä·¥ç·¥Ä·¥õ:\n`<shortener_url> <api_key>`")

    


    elif data == 'set_shortener_details':
        if await authoUser(query, query.from_user.id, owner_only=True):
            try:
            # Step 1: Prompt for the shortener URL with a timeout of 1 minute
                await query.answer("¬ª ·¥ò ü·¥á·¥Äs·¥á s·¥á…¥·¥Ö ·¥õ ú·¥á s ú·¥è Ä·¥õ…¥·¥á Ä ·¥ú Ä ü ·¥°…™·¥õ ú…™…¥ 1 ·¥ç…™…¥·¥ú·¥õ·¥á...")
                set_msg_url = await query.message.reply(
                    "¬ª ·¥ò ü·¥á·¥Äs·¥á ·¥ò Ä·¥è·¥†…™·¥Ö·¥á ·¥õ ú·¥á s ú·¥è Ä·¥õ…¥·¥á Ä s…™·¥õ·¥á ·¥ú Ä ü (e.g., inshorturl.com) ·¥°…™·¥õ ú…™…¥ 1 ·¥ç…™…¥·¥ú·¥õ·¥á..",
                    reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton('‚Ä¢   ô·¥Ä·¥Ñ·¥ã  ‚Ä¢', callback_data='set_shortener')]])
                )
                site_msg = await client.ask(
                    chat_id=query.from_user.id,
                    text="¬ª ·¥á…¥·¥õ·¥á Ä s ú·¥è Ä·¥õ…¥·¥á Ä s…™·¥õ·¥á ·¥ú Ä ü:",
                    timeout=60
                )

                shortener_url = site_msg.text.strip()


            # Confirm the shortener site URL
                await site_msg.reply(f"¬ª s ú·¥è Ä·¥õ…¥·¥á Ä s…™·¥õ·¥á ·¥ú Ä ü s·¥á·¥õ ·¥õ·¥è: {shortener_url}\n\n¬ª …¥·¥è·¥° ·¥ò ü·¥á·¥Äs·¥á s·¥á…¥·¥Ö ·¥õ ú·¥á ·¥Ä·¥ò…™ ·¥ã·¥á è.")

            # Step 3: Prompt for API key
                set_msg_api = await query.message.reply(
                    "¬ª ·¥ò ü·¥á·¥Äs·¥á ·¥ò Ä·¥è·¥†…™·¥Ö·¥á ·¥õ ú·¥á ·¥Ä·¥ò…™ ·¥ã·¥á è “ì·¥è Ä ·¥õ ú·¥á s ú·¥è Ä·¥õ…¥·¥á Ä ·¥°…™·¥õ ú…™…¥ 1 ·¥ç…™…¥·¥ú·¥õ·¥á.",
                    reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton('‚Ä¢   ô·¥Ä·¥Ñ·¥ã  ‚Ä¢', callback_data='set_shortener')]])
                )

                api_msg = await client.ask(
                    chat_id=query.from_user.id,
                    text="¬ª ·¥ò ü·¥á·¥Äs·¥á ·¥á…¥·¥õ·¥á Ä ·¥Ä·¥ò…™ ·¥ã·¥á è “ì·¥è Ä s ú·¥è Ä·¥õ…¥·¥á Ä:",
                    timeout=60
                )

                api_key = api_msg.text.strip()

            # Step 4: Save the shortener details in the database
                await db.set_shortener_url(shortener_url)
                await db.set_shortener_api(api_key)
            
            # Confirmation message
                await api_msg.reply(
                    "‚úÖ Shortener details have been successfully set!",
                    reply_markup=InlineKeyboardMarkup([
                        [InlineKeyboardButton('·¥Ö…™s·¥Ä ô ü·¥á s ú·¥è Ä·¥õ…¥·¥á Ä ‚ùå', callback_data='disable_shortener')],
                        [InlineKeyboardButton('‚Ä¢   ô·¥Ä·¥Ñ·¥ã  ‚Ä¢', callback_data='set_shortener')]
                    ])
                )
            except asyncio.TimeoutError:
                await query.message.reply(
                    "¬ª ùêÄùêãùêÑùêëùêì: Timeout\n\n¬ª  è·¥è·¥ú ·¥Ö…™·¥Ö …¥·¥è·¥õ ·¥ò Ä·¥è·¥†…™·¥Ö·¥á ·¥õ ú·¥á ·¥Ö·¥á·¥õ·¥Ä…™ üs …™…¥ …¢…™·¥†·¥á…¥ ·¥õ…™·¥ç·¥á. ·¥ò ü·¥á·¥Äs·¥á ·¥õ Ä è ·¥Ä…¢·¥Ä…™…¥.",
                    reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton('‚Ä¢   ô·¥Ä·¥Ñ·¥ã  ‚Ä¢', callback_data='set_shortener')]])
                )
            except Exception as e:
                logging.error(f"Error setting shortener details: {e}")  # This now works correctly
                await query.message.reply(
                    f"‚ö†Ô∏è Error occurred: {e}",
    reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton('‚Ä¢   ô·¥Ä·¥Ñ·¥ã  ‚Ä¢', callback_data='set_shortener')]])
    )

    elif data == "set_shortener":
        if await authoUser(query, query.from_user.id, owner_only=True):
            try:
            # Simulate the command being run again by accessing the message where the button was pressed
                message = query.message  # Access the message where the button was pressed

            # Fetch the shortener URL and API from the database
                shortener_url = await db.get_shortener_url()
                shortener_api = await db.get_shortener_api()

            # Check if both shortener URL and API are available
                if shortener_url and shortener_api:
            # If both URL and API key are available, the shortener is considered "Enabled ‚úÖ"
                    shortener_status = "·¥á…¥·¥Ä ô ü·¥á·¥Ö ‚úÖ"
                    mode_button = InlineKeyboardButton('·¥Ö…™s·¥Ä ô ü·¥á s ú·¥è Ä·¥õ…¥·¥á Ä ‚ùå', callback_data='disable_shortener')
                else:
            # If either URL or API key is missing, the shortener is "Disabled ‚ùå"
                    shortener_status = "·¥Ö…™s·¥Ä ô ü·¥á·¥Ö ‚ùå"
                    mode_button = InlineKeyboardButton('·¥á…¥·¥Ä ô ü·¥á s ú·¥è Ä·¥õ…¥·¥á Ä ‚úÖ', callback_data='set_shortener_details')

       
            # Refresh the settings and update the message with new content
                await message.reply_photo(
                    photo=START_PIC,
                    caption=SET_SHORTENER_CMD_TXT.format(
                        shortener_status=shortener_status),
                    reply_markup=InlineKeyboardMarkup([
                        [mode_button],
                        [InlineKeyboardButton('Settings ‚öôÔ∏è', callback_data='shortener_settings'),
                     InlineKeyboardButton('üîÑ Refresh', callback_data='set_shortener')],
                        [InlineKeyboardButton('Set Verified Time ‚è±', callback_data='set_verify_time'),
                     InlineKeyboardButton('Set Tutorial Video üé•', callback_data='set_tut_video')],
                        [InlineKeyboardButton('Close ‚úñÔ∏è', callback_data='close')]
                    ])
                )
            except Exception as e:
            # If an error occurs, display an error message with a contact option
                await query.message.edit_text(
                    f"<b>! ·¥á Ä Ä·¥è Ä ·¥è·¥Ñ·¥Ñ·¥ú Ä·¥á·¥Ö..\n\n<blockquote> Ä·¥á·¥Äs·¥è…¥:</b> {e}</blockquote><b>·¥Ñ·¥è…¥·¥õ·¥Ä·¥Ñ·¥õ ·¥Ö·¥á·¥†·¥á ü·¥è·¥ò·¥á Ä: @urr_sanjiii</b>",
                    reply_markup=InlineKeyboardMarkup(
                        [[InlineKeyboardButton("‚Ä¢  ·¥Ñ ü·¥ès·¥á  ‚Ä¢", callback_data="close")]]
                    )
                )


    elif data == "set_tut_video":
        id = query.from_user.id

        if await authoUser(query, id, owner_only=True):
            await query.answer("‚ôªÔ∏è Q·¥ú·¥á Ä è P Ä·¥è·¥Ñ·¥áss…™…¥…¢...!!!")
        
            try:
            # Fetch the current tutorial video URL from the database
                current_video_url = await db.get_tut_video()

            # Prompt the user to input the new tutorial video URL
                set_msg = await client.ask(
                    chat_id=id,
                    text=f'<b><blockquote>¬ª ·¥Ñ·¥ú Ä Ä·¥á…¥·¥õ ·¥õ·¥ú·¥õ·¥è Ä…™·¥Ä ü ·¥†…™·¥Ö·¥á·¥è URL: {current_video_url if current_video_url else "…¥·¥è·¥õ s·¥á·¥õ"}</blockquote>\n\n¬ª ·¥õ·¥è ·¥Ñ ú·¥Ä…¥…¢·¥á, ·¥ò ü·¥á·¥Äs·¥á s·¥á…¥·¥Ö ·¥Ä ·¥†·¥Ä ü…™·¥Ö ·¥†…™·¥Ö·¥á·¥è URL.\n\n<blockquote>“ì·¥è Ä ·¥áx·¥Ä·¥ç·¥ò ü·¥á: <code>https://t.me/anime_raven/829</code></b></blockquote>',
                    timeout=60
                )

            # Validate the user input for a valid URL
                video_url = set_msg.text.strip()

                if video_url.startswith("http") and "://" in video_url:
                # Save the new tutorial video URL to the database
                    await db.set_tut_video(video_url)

                # Confirm the update to the user
                    await set_msg.reply(f"<b>¬ª ·¥õ·¥ú·¥õ·¥è Ä…™·¥Ä ü ·¥†…™·¥Ö·¥á·¥è URL s·¥á·¥õ s·¥ú·¥Ñ·¥Ñ·¥áss“ì·¥ú ü ü è ‚úÖ\n\n<blockquote>¬ª ·¥Ñ·¥ú Ä Ä·¥á…¥·¥õ ·¥õ·¥ú·¥õ·¥è Ä…™·¥Ä ü ·¥†…™·¥Ö·¥á·¥è URL: {video_url}</blockquote></b>")
                else:
                # If the URL is invalid, prompt the user to try again
                    markup = [[InlineKeyboardButton(
                        's·¥á·¥õ ·¥õ·¥ú·¥õ·¥è Ä…™·¥Ä ü ·¥†…™·¥Ö·¥á·¥è ·¥ú Ä ü', callback_data='set_tut_video')]]
                    return await set_msg.reply(
                        "<b>·¥ò ü·¥á·¥Äs·¥á s·¥á…¥·¥Ö ·¥Ä  ü…™…¥·¥ã ·¥õ·¥è ·¥Ä ·¥†·¥Ä ü…™·¥Ö ·¥†…™·¥Ö·¥á·¥è.\n\n<blockquote>“ì·¥è Ä ·¥áx·¥Ä·¥ç·¥ò ü·¥á: <code>https://t.me/Battousai_Network/31</code></blockquote>\n\n¬ª ·¥õ Ä è ·¥Ä…¢·¥Ä…™…¥  ô è ·¥Ñ ü…™·¥Ñ·¥ã…™…¥…¢  ô·¥á ü·¥è·¥°  ô·¥ú·¥õ·¥õ·¥è…¥..!!</b>", reply_markup=InlineKeyboardMarkup(markup))

            except Exception as e:
                try:
                # Handle any exceptions that occur during the process
                    await set_msg.reply(f"<b>! ·¥á Ä Ä·¥è Ä ·¥è·¥Ñ·¥Ñ·¥ú Ä·¥á·¥Ö..\n\n<blockquote> Ä·¥á·¥Äs·¥è…¥:</b> {e}</blockquote>")
                    print(f"! Error Occurred on callback data = 'set_tut_video' : {e}")
                except BaseException:
                # If an error occurs while sending the error message, send a timeout message
                    await client.send_message(id, text=f"<b>! ·¥á Ä Ä·¥è Ä ·¥è·¥Ñ·¥Ñ·¥ú Ä·¥á·¥Ö..\n\n<blockquote> Ä·¥á·¥Äs·¥è…¥: 1 minute Time out...!!!</b></blockquote>", disable_notification=True)
                    print(f"! Error Occurred on callback data = 'set_tut_video' -> Reason: 1 minute Time out ..")


    elif data == 'set_verify_time':
        id = query.from_user.id

        if await authoUser(query, id, owner_only=True):
            await query.answer("‚ôªÔ∏è Processing Request...!!!")

            try:
                # Fetch the current verified time from the database
                current_verify_time = await db.get_verified_time()
                time_display = f"{current_verify_time} s·¥á·¥Ñ·¥è…¥·¥Ös" if current_verify_time else "…¥·¥è·¥õ s·¥á·¥õ"

                # Prompt the user to input a new verified time
                set_msg = await client.ask(
                    chat_id=id,
                    text=(
                        f"<b><blockquote>¬ª Current Timer: {time_display}</blockquote>\n\n"
                        f"To change the timer, please send a valid number in seconds within 1 minute.\n\n"
                        f"<blockquote>For example: <code>300</code>, <code>600</code>, <code>900</code></blockquote></b>"
                    ),
                    timeout=60
                )

                # Validate the user input
                verify_time_input = set_msg.text.strip()
                if verify_time_input.isdigit():
                    verify_time = int(verify_time_input)

                    # Save the new verified time to the database
                    await db.set_verified_time(verify_time)
                    formatted_time = f"{verify_time} s·¥á·¥Ñ·¥è…¥·¥Ös"
                    
                    # Confirm the update to the user
                    await set_msg.reply(
                        f"<b>Timer updated successfully ‚úÖ\n\n"
                        f"<blockquote>¬ª Current Timer: {formatted_time}</blockquote></b>"
                    )
                else:
                    # Handle invalid input
                    markup = [[InlineKeyboardButton('‚Ä¢ ·¥Ñ ü…™·¥Ñ·¥ã ·¥õ·¥è s·¥á·¥õ ·¥†·¥á Ä…™“ì è ·¥õ…™·¥ç·¥á Ä ‚Ä¢', callback_data='set_verify_time')]]
                    return await set_msg.reply(
                        "<b>Please send a valid number in seconds.\n\n"
                        "<blockquote>For example: <code>300</code>, <code>600</code>, <code>900</code></blockquote>\n\n"
                        "Try again by clicking the button below...!!!</b>",
                        reply_markup=InlineKeyboardMarkup(markup)
                    )

            except asyncio.TimeoutError:
                # Handle timeout if user doesn't respond in time
                await client.send_message(
                    id,
                    text="<b>‚ö†Ô∏è Timeout occurred. You did not respond within the time limit.</b>",
                    disable_notification=True
                )
            except Exception as e:
                # Handle any other exceptions
                await client.send_message(
                    id,
                    text=f"<b> ·¥á Ä Ä·¥è Ä ·¥è·¥Ñ·¥Ñ·¥ú Ä·¥á·¥Ö:\n<blockquote>{e}</blockquote></b>",
                    disable_notification=True
                )
                print(f"! Error occurred on callback data = 'set_verify_time' : {e}")



    elif data == "enable_shortener":
        await query.answer()

        try:
            # Check if shortener details are already set
            shortener_url = await db.get_shortener_url()
            shortener_api = await db.get_shortener_api()

            if shortener_url and shortener_api:
                # Enable the shortener
                success_url = await db.set_shortener_url(shortener_url)
                success_api = await db.set_shortener_api(shortener_api)

                if success_url and success_api:
                    await query.edit_message_caption(
                        caption="Shortener has been enabled ‚úÖ",
                        reply_markup=InlineKeyboardMarkup([
                            [InlineKeyboardButton('·¥Ö…™s·¥Ä ô ü·¥á s ú·¥è Ä·¥õ…¥·¥á Ä ‚ùå', callback_data='disable_shortener')],
                            [InlineKeyboardButton('·¥Ñ ü·¥ès·¥á ', callback_data='close')]
                        ])
                    )
                else:
                    await query.message.reply(
                        "Failed to enable the shortener. Please try again."
                    )
            else:
                # If no shortener details are found, prompt the user to set them
                await query.edit_message_caption(
                    caption="No shortener details found. Please set the shortener details first.",
                    reply_markup=InlineKeyboardMarkup([
                        [InlineKeyboardButton('‚Ä¢ ·¥Ñ ü…™·¥Ñ·¥ã ·¥õ·¥è s·¥á·¥õ s ú·¥è Ä·¥õ…¥·¥á Ä ·¥Ö·¥á·¥õ·¥Ä…™ üs ‚Ä¢', callback_data='set_shortener_details')],
                        [InlineKeyboardButton('‚Ä¢ ·¥Ñ ü…™·¥Ñ·¥ã ·¥õ·¥è ·¥Ñ ü·¥ès·¥á ·¥õ ú…™s ·¥ò·¥Ä…¥·¥á ü ‚Ä¢', callback_data='close')]
                    ])
                )
        except Exception as e:
            logging.error(f"Error enabling shortener: {e}")
            await query.message.reply(
                "An unexpected error occurred while enabling the shortener. Please try again later."
            )

    elif data == "disable_shortener":
        await query.answer()
    
    # Deactivate the shortener
        success = await db.deactivate_shortener()
        if success:
            await query.edit_message_caption(
                caption="Shortener has been disabled ‚ùå",
                reply_markup=InlineKeyboardMarkup([
                    [InlineKeyboardButton('·¥á…¥·¥Ä ô ü·¥á s ú·¥è Ä·¥õ…¥·¥á Ä ‚úÖ', callback_data='enable_shortener')],
                    [InlineKeyboardButton('‚Ä¢ ·¥Ñ ü…™·¥Ñ·¥ã ·¥õ·¥è ·¥Ñ ü·¥ès·¥á ·¥õ ú…™s ·¥ò·¥Ä…¥·¥á ü ‚Ä¢', callback_data='close')]
                ])
            )
        else:
            await query.message.reply("Failed to disable the shortener. Please try again.")



    elif data.startswith("detail_"):
        mal_id = data.split("_")[1]
        url = f"https://api.jikan.moe/v4/anime/{mal_id}"
        anime_data = await fetch_anime_data(url)

        if anime_data and "data" in anime_data:
            anime = anime_data["data"]
            details = (
                f"¬ª ·¥õ…™·¥õ ü·¥á: {style_anime_title(anime.get('title'))}\n"
                f"¬ª ·¥õ è·¥ò·¥á: {anime.get('type', 'N/A')}\n"
                f"¬ª ·¥á·¥ò…™s·¥è·¥Ö·¥ás: {anime.get('episodes', 'Unknown')}\n"
                f"¬ª s·¥Ñ·¥è Ä·¥á: {anime.get('score', 'N/A')}\n"
                f"¬ª s è…¥·¥è·¥òs…™s: {anime.get('synopsis', 'No synopsis available.')}\n"
                f"[MyAnimeList]({anime.get('url', '#')})"
            )

            await query.message.edit_text(
                details,
                reply_markup=InlineKeyboardMarkup(
                    [[InlineKeyboardButton("‚Ä¢ ·¥Ñ ü…™·¥Ñ·¥ã ·¥õ·¥è ·¥Ñ ü·¥ès·¥á ·¥õ ú…™s ·¥ò·¥Ä…¥·¥á ü ‚Ä¢", callback_data='close')]]
                ),
                parse_mode=ParseMode.MARKDOWN
            )
        else:
            await query.answer("Failed to fetch anime details..!!", show_alert=True)
